{% extends "layout.html" %}

{% block title %}Dashboard - Fitness Flow{% endblock %}

{% block content %}
<div class="bento-grid">

    <!-- Welcome & Stats Card (Feature) -->
    <div class="bento-card feature-card col-span-2">
        <div class="bento-card-bg">
            <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <circle cx="100" cy="100" r="80" fill="rgba(255,255,255,0.1)" />
                <circle cx="100" cy="100" r="50" fill="rgba(255,255,255,0.1)" />
            </svg>
        </div>
        <div class="bento-card-content">
            <div class="bento-card-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
            </div>
            <h3 class="bento-card-title">Hello, {{ user.username }}!</h3>
            <p class="bento-card-description">Track your meals accurately and reach your fitness goals.</p>

            <div class="bento-stats">
                <div class="bento-stat-item">
                    <span class="bento-stat-value">{{ totals.calories }}</span>
                    <span class="bento-stat-label">Calories</span>
                </div>
                <div class="bento-stat-item">
                    <span class="bento-stat-value">{{ totals.protein | round(1) }}g</span>
                    <span class="bento-stat-label">Protein</span>
                </div>
                <div class="bento-stat-item">
                    <span class="bento-stat-value">{{ totals.carbs | round(1) }}g</span>
                    <span class="bento-stat-label">Carbs</span>
                </div>
                <div class="bento-stat-item">
                    <span class="bento-stat-value">{{ totals.fats | round(1) }}g</span>
                    <span class="bento-stat-label">Fats</span>
                </div>
            </div>
        </div>
        <div class="bento-card-cta">
            <a href="/logout" class="bento-cta-btn" style="color: white;">
                Logout
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
            </a>
        </div>
    </div>

    <!-- Search Foods Card -->
    <div class="bento-card row-span-2">
        <div class="bento-card-bg">
            <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <path d="M100 20 L180 100 L100 180 L20 100 Z" fill="rgba(0,0,0,0.05)" />
            </svg>
        </div>
        <div class="bento-card-body">
            <div class="bento-card-content" style="padding: 0 0 16px 0;">
                <div class="bento-card-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <h3 class="bento-card-title">Search Foods</h3>
                <p class="bento-card-description">Find nutritional info for any food</p>
            </div>

            <div class="search-bar-container">
                <input type="text" id="foodInput" class="search-input" placeholder="e.g. 2 Porotta, Fish Curry...">
                <button onclick="searchFood()" class="search-btn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>

            <!-- Search Results -->
            <div id="result" style="display: none; animation: slideUp 0.3s ease-out;">
                <div class="result-card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div>
                            <span id="sourceBadge" class="badge"></span>
                            <h2 id="foodName" style="margin-top: 8px;">Food Name</h2>
                        </div>
                        <div style="text-align: right;">
                            <label style="font-size: 0.8rem;">Servings</label>
                            <input type="number" id="qtyInput" value="1" min="0.5" step="0.5" onchange="updateMath()"
                                class="servings-input">
                        </div>
                    </div>

                    <div class="macro-cards">
                        <div class="macro-card">
                            <span class="macro-label">Calories</span>
                            <span class="macro-value"><span id="dispCal">0</span></span>
                        </div>
                        <div class="macro-card">
                            <span class="macro-label">Protein</span>
                            <span class="macro-value"><span id="dispPro">0</span>g</span>
                        </div>
                        <div class="macro-card">
                            <span class="macro-label">Carbs</span>
                            <span class="macro-value"><span id="dispCarbs">0</span>g</span>
                        </div>
                    </div>

                    <button onclick="addToLog()" class="btn-primary" style="margin-top: 20px;">
                        Add to My Day
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            style="margin-left: 8px; vertical-align: middle;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's History Card -->
    <div class="bento-card col-span-2 row-span-2">
        <div class="bento-card-bg">
            <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <rect x="40" y="40" width="120" height="120" rx="20" fill="rgba(0,0,0,0.03)" />
            </svg>
        </div>
        <div class="bento-card-body">
            <div class="bento-card-content" style="padding: 0 0 16px 0;">
                <div class="bento-card-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                        </path>
                    </svg>
                </div>
                <h3 class="bento-card-title">Today's Food History</h3>
                <p class="bento-card-description">Your logged meals for today</p>
            </div>

            {% if logs %}
            <ul class="food-list" style="margin: 0; max-height: 300px; overflow-y: auto;">
                {% for log in logs %}
                <li class="food-item">
                    <div class="food-info">
                        <h4>{{ log.food_name }}</h4>
                        <span class="food-meta">{{ log.quantity }} serving(s) ‚Ä¢ {{ log.total_calories }} kcal</span>
                    </div>
                    <div style="text-align: right;">
                        <span style="font-weight: 700; color: #22c55e;">{{ log.total_protein }}g P</span>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    style="opacity: 0.5; margin-bottom: 12px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                    </path>
                </svg>
                <p>No food logged today</p>
                <p style="font-size: 0.85rem; margin-top: 4px;">Search and add your meals above</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- AI Coach Card (Clickable) -->
    <div class="bento-card" onclick="toggleChat()" style="cursor: pointer;">
        <div class="bento-card-bg">
            <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <circle cx="150" cy="50" r="60" fill="rgba(0,0,0,0.03)" />
            </svg>
        </div>
        <div class="bento-card-content">
            <div class="bento-card-icon" style="background: linear-gradient(135deg, #8b5cf6, #ec4899);">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                    </path>
                </svg>
            </div>
            <h3 class="bento-card-title">AI Coach</h3>
            <p class="bento-card-description">Get personalized diet and exercise tips from your AI fitness assistant.
            </p>
        </div>
        <div class="bento-card-cta">
            <span class="bento-cta-btn">
                Start Chat
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3">
                    </path>
                </svg>
            </span>
        </div>
    </div>

</div>

<!-- AI Widget -->
<div class="ai-widget-container">
    <div class="ai-bubble">
        Chetten here! üëã
    </div>
    <button class="ai-avatar-btn" onclick="toggleChat()">
        <img src="{{ url_for('static', filename='bot_icon.png') }}" alt="AI Bot" class="ai-avatar-img">
    </button>

    <!-- Chat Window -->
    <div id="chat-box" class="chat-window">
        <div class="chat-header">
            <span>Fitness Assistant</span>
            <span onclick="toggleChat()" style="cursor: pointer; opacity: 0.8;">‚úï</span>
        </div>

        <div id="chat-messages" class="chat-body">
            <div style="margin-bottom: 15px; color: var(--text-secondary); font-size: 0.9rem;">
                <b>Coach:</b> Namaskaram! Ask me anything about diet or exercise.
            </div>
        </div>

        <div class="chat-footer">
            <input type="text" id="chatInput" class="chat-input" placeholder="Ask query..."
                onkeypress="handleEnter(event)">
            <button onclick="sendMessage()" class="chat-send">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    let currentFood = {};

    async function searchFood() {
        const query = document.getElementById('foodInput').value;
        const card = document.getElementById('result');

        if (!query) return;

        document.getElementById('foodName').innerText = "Searching...";
        card.style.display = 'block';

        const response = await fetch(`/search_food?query=${query}`);
        const data = await response.json();

        if (data.error) {
            document.getElementById('foodName').innerText = "‚ùå Not found. Try again.";
        } else {
            currentFood = data;
            document.getElementById('foodName').innerText = data.name;

            const badge = document.getElementById('sourceBadge');
            if (data.source === 'database') {
                badge.innerText = "‚ö° Database";
                badge.className = "badge badge-db";
            } else {
                badge.innerText = "ü§ñ AI Generated";
                badge.className = "badge badge-ai";
            }

            document.getElementById('qtyInput').value = 1;
            updateMath();
        }
    }

    function updateMath() {
        const qty = parseFloat(document.getElementById('qtyInput').value) || 0;
        document.getElementById('dispCal').innerText = Math.round(currentFood.calories * qty);
        document.getElementById('dispPro').innerText = (currentFood.protein * qty).toFixed(1);
        document.getElementById('dispCarbs').innerText = (currentFood.carbs * qty).toFixed(1);
    }

    async function addToLog() {
        const qty = parseFloat(document.getElementById('qtyInput').value);

        const payload = {
            name: currentFood.name,
            quantity: qty,
            calories: Math.round(currentFood.calories * qty),
            protein: (currentFood.protein * qty),
            carbs: (currentFood.carbs * qty),
            fats: (currentFood.fats * qty)
        };

        const response = await fetch('/add_log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        // Reload to show new log
        window.location.reload();
    }

    // Chat Functions
    function toggleChat() {
        const box = document.getElementById('chat-box');
        if (box.style.display === 'flex') {
            box.style.display = 'none';
        } else {
            box.style.display = 'flex';
        }
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const messages = document.getElementById('chat-messages');
        const userText = input.value;

        if (!userText) return;

        messages.innerHTML += `<div style="margin-bottom: 10px; text-align: right;"><span style="background: #e0e7ff; padding: 8px 12px; border-radius: 12px 12px 0 12px; display: inline-block;">${userText}</span></div>`;
        input.value = '';
        messages.scrollTop = messages.scrollHeight;

        const loadingId = "loading-" + Date.now();
        messages.innerHTML += `<div id="${loadingId}" style="margin-bottom: 10px; text-align: left; color: #888; font-size: 0.8rem;"><i>Coach is typing...</i></div>`;

        const response = await fetch('/ask_ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userText })
        });
        const data = await response.json();

        document.getElementById(loadingId).remove();
        messages.innerHTML += `<div style="margin-bottom: 15px; text-align: left;"><span style="background: white; padding: 8px 12px; border-radius: 12px 12px 12px 0; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">${data.reply}</span></div>`;
        messages.scrollTop = messages.scrollHeight;
    }
</script>
{% endblock %}