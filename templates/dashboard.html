{% extends "layout.html" %}

{% block title %}Dashboard - Fitness Pro{% endblock %}

{% block content %}
<div class="dashboard-grid">

    <!-- Main Content Area -->
    <div style="display: flex; flex-direction: column; gap: 24px;">

        <!-- Welcome Section -->
        <div class="glass-card"
            style="padding: 30px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>Hello, {{ user.username }} üëã</h1>
                <p>Track your Kerala meals accurately.</p>
            </div>
            <a href="/logout" class="btn-primary"
                style="width: auto; padding: 10px 20px; background: #ef4444;">Logout</a>
        </div>

        <!-- Search Section -->
        <div class="glass-card">
            <h2 style="margin-bottom: 20px;">Search Foods & Macros</h2>

            <div class="search-bar-container">
                <input type="text" id="foodInput" class="search-input"
                    placeholder="Search (e.g. 2 Porotta, Fish Curry)...">
                <button onclick="searchFood()" class="search-btn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>

            <!-- Search Results (Hidden by default) -->
            <div id="result" style="display: none; animation: slideUp 0.3s ease-out;">
                <div style="background: rgba(255,255,255,0.5); border-radius: 16px; padding: 24px; margin-top: 20px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div>
                            <span id="sourceBadge" class="badge"></span>
                            <h2 id="foodName" style="margin-top: 8px;">Food Name</h2>
                        </div>
                        <div style="text-align: right;">
                            <label style="font-size: 0.8rem;">Servings</label>
                            <input type="number" id="qtyInput" value="1" min="0.5" step="0.5" onchange="updateMath()"
                                style="width: 80px; padding: 8px; border-radius: 8px; border: 1px solid #ddd; text-align: center;">
                        </div>
                    </div>

                    <div class="macro-cards">
                        <div class="macro-card">
                            <span class="macro-label">Calories</span>
                            <span class="macro-value" style="color: #ef4444;"><span id="dispCal">0</span></span>
                        </div>
                        <div class="macro-card">
                            <span class="macro-label">Protein</span>
                            <span class="macro-value" style="color: #22c55e;"><span id="dispPro">0</span>g</span>
                        </div>
                        <div class="macro-card">
                            <span class="macro-label">Carbs</span>
                            <span class="macro-value" style="color: #3b82f6;"><span id="dispCarbs">0</span>g</span>
                        </div>
                    </div>

                    <button onclick="addToLog()" class="btn-primary" style="margin-top: 20px;">Add to My Day üìÖ</button>
                </div>
            </div>
        </div>

        <!-- Today's History -->
        <div class="glass-card">
            <h2 style="margin-bottom: 20px;">Today's Food History</h2>

            {% if logs %}
            <ul class="food-list">
                {% for log in logs %}
                <li class="food-item">
                    <div class="food-info">
                        <h4>{{ log.food_name }}</h4>
                        <span class="food-meta">{{ log.quantity }} serving(s) ‚Ä¢ {{ log.total_calories }} kcal</span>
                    </div>
                    <div style="text-align: right;">
                        <span style="font-weight: 700; color: #22c55e;">{{ log.total_protein }}g P</span>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <p>No food logged today. Eat something! üçΩÔ∏è</p>
            </div>
            {% endif %}
        </div>

    </div>

    <!-- Sidebar (Totals) -->
    <div style="display: flex; flex-direction: column; gap: 24px;">
        <div class="glass-card" style="background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); color: white;">
            <h3 style="color: white; margin-bottom: 20px; opacity: 0.9;">Daily Summary</h3>

            <div style="text-align: center; margin-bottom: 30px;">
                <span style="font-size: 3.5rem; font-weight: 800; line-height: 1;">{{ totals.calories }}</span>
                <span style="display: block; font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">Total Calories</span>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; text-align: center;">
                    <span style="display: block; font-size: 1.5rem; font-weight: 700;">{{ totals.protein | round(1)
                        }}g</span>
                    <span style="font-size: 0.8rem; opacity: 0.8;">Protein</span>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; text-align: center;">
                    <span style="display: block; font-size: 1.5rem; font-weight: 700;">{{ totals.carbs | round(1)
                        }}g</span>
                    <span style="font-size: 0.8rem; opacity: 0.8;">Carbs</span>
                </div>
                <div
                    style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; text-align: center; grid-column: span 2;">
                    <span style="display: block; font-size: 1.5rem; font-weight: 700;">{{ totals.fats | round(1)
                        }}g</span>
                    <span style="font-size: 0.8rem; opacity: 0.8;">Fats</span>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- AI Widget -->
<div class="ai-widget-container">
    <div class="ai-bubble">
        Chetten here! üëã
    </div>
    <button class="ai-avatar-btn" onclick="toggleChat()">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="AI Bot" class="ai-avatar-img">
    </button>

    <!-- Chat Window -->
    <div id="chat-box" class="chat-window">
        <div class="chat-header">
            <span>Fitness Coach</span>
            <span onclick="toggleChat()" style="cursor: pointer; opacity: 0.8;">‚úï</span>
        </div>

        <div id="chat-messages" class="chat-body">
            <div style="margin-bottom: 15px; color: var(--text-secondary); font-size: 0.9rem;">
                <b>Coach:</b> Namaskaram! Ask me anything about diet or exercise.
            </div>
        </div>

        <div class="chat-footer">
            <input type="text" id="chatInput" class="chat-input" placeholder="Ask query..."
                onkeypress="handleEnter(event)">
            <button onclick="sendMessage()" class="chat-send">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    let currentFood = {};

    async function searchFood() {
        const query = document.getElementById('foodInput').value;
        const card = document.getElementById('result');

        if (!query) return;

        document.getElementById('foodName').innerText = "Searching...";
        card.style.display = 'block';

        const response = await fetch(`/search_food?query=${query}`);
        const data = await response.json();

        if (data.error) {
            document.getElementById('foodName').innerText = "‚ùå Not found. Try again.";
        } else {
            currentFood = data;
            document.getElementById('foodName').innerText = data.name;

            const badge = document.getElementById('sourceBadge');
            if (data.source === 'database') {
                badge.innerText = "‚ö° Database";
                badge.className = "badge badge-db";
            } else {
                badge.innerText = "ü§ñ AI Generated";
                badge.className = "badge badge-ai";
            }

            document.getElementById('qtyInput').value = 1;
            updateMath();
        }
    }

    function updateMath() {
        const qty = parseFloat(document.getElementById('qtyInput').value) || 0;
        document.getElementById('dispCal').innerText = Math.round(currentFood.calories * qty);
        document.getElementById('dispPro').innerText = (currentFood.protein * qty).toFixed(1);
        document.getElementById('dispCarbs').innerText = (currentFood.carbs * qty).toFixed(1);
    }

    async function addToLog() {
        const qty = parseFloat(document.getElementById('qtyInput').value);

        const payload = {
            name: currentFood.name,
            quantity: qty,
            calories: Math.round(currentFood.calories * qty),
            protein: (currentFood.protein * qty),
            carbs: (currentFood.carbs * qty),
            fats: (currentFood.fats * qty)
        };

        const response = await fetch('/add_log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        // Reload to show new log
        window.location.reload();
    }

    // Chat Functions
    function toggleChat() {
        const box = document.getElementById('chat-box');
        if (box.style.display === 'flex') {
            box.style.display = 'none';
        } else {
            box.style.display = 'flex';
        }
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const messages = document.getElementById('chat-messages');
        const userText = input.value;

        if (!userText) return;

        messages.innerHTML += `<div style="margin-bottom: 10px; text-align: right;"><span style="background: #e0e7ff; padding: 8px 12px; border-radius: 12px 12px 0 12px; display: inline-block;">${userText}</span></div>`;
        input.value = '';
        messages.scrollTop = messages.scrollHeight;

        const loadingId = "loading-" + Date.now();
        messages.innerHTML += `<div id="${loadingId}" style="margin-bottom: 10px; text-align: left; color: #888; font-size: 0.8rem;"><i>Coach is typing...</i></div>`;

        const response = await fetch('/ask_ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userText })
        });
        const data = await response.json();

        document.getElementById(loadingId).remove();
        messages.innerHTML += `<div style="margin-bottom: 15px; text-align: left;"><span style="background: white; padding: 8px 12px; border-radius: 12px 12px 12px 0; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">${data.reply}</span></div>`;
        messages.scrollTop = messages.scrollHeight;
    }
</script>
{% endblock %}